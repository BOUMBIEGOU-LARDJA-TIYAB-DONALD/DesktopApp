@using desktop_app_hybrid.Services
@inject AuthService Auth
@inject NavigationManager Nav
@using System.ComponentModel.DataAnnotations

<div class="auth-card">
    <div class="logo">
        <img class="logo-icon" src="https://i.ibb.co/yF9Ct6Vh/e45cad7b-df02-42d6-a6ee-1cbb9de115ab.jpg">
        <div class="logo-text">GradeMaster</div>
    </div>

    <h1>Créer Votre Compte GradeMaster</h1>
    <p class="subtitle">
        Débloquez une gestion et notation efficace des étudiants. Rejoignez GradeMaster aujourd'hui !
    </p>

    <EditForm Model="@model" OnValidSubmit="Submit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        @if (message != null)
        {
            <p style="font-weight:bolder">@message</p>
        }

        <div class="form-group">
            <label>Email</label>
            <InputText @bind-Value="model.Email" />
        </div>

        <div class="form-group">
            <label>Nom d'utilisateur</label>
            <InputText @bind-Value="model.Username" />
        </div>

        <div class="form-group">
            <label>Nom</label>
            <InputText @bind-Value="model.Nom" />
        </div>

        <div class="form-group">
            <label>Prénoms</label>
            <InputText @bind-Value="model.Prenoms" />
        </div>

        <div class="form-group">
            <label>Mot de passe</label>
            <!-- input HTML + oninput handler that accepts ChangeEventArgs -->
            <input type="password"
                   value="@model.Password"
                   @oninput="OnPasswordInput"
                   class="form-control" />
        </div>

        <div class="form-group">
            <label>Confirmer le mot de passe</label>
            <input type="password"
                   value="@model.ConfirmPassword"
                   @oninput="OnConfirmPasswordInput"
                   class="form-control" />
        </div>

        @if (mes != null)
        {
            <p style="color:@colorvar;font-weight:bold">@mes</p>
        }

        <div class="form-group">
            <label>Rôle</label>
            <InputSelect @bind-Value="model.Role">
                <option value="etudiants">Étudiant</option>
                <option value="enseignants">Enseignant</option>
            </InputSelect>
        </div>

        <button type="submit" disabled="@odiasble">Créer le Compte</button>
    </EditForm>

    <div class="footer">
        Vous avez déjà un compte ? <a href="/login">Se connecter</a>
    </div>
</div>

@code {
    string? message;
    string? mes;
    string colorvar = "green";
    bool odiasble = true;

    SignupModel model = new();

    // Handlers that accept ChangeEventArgs (no conversion error)
    Task OnPasswordInput(ChangeEventArgs e)
    {
        model.Password = e?.Value?.ToString() ?? "";
        CheckPasswords();
        return Task.CompletedTask;
    }

    Task OnConfirmPasswordInput(ChangeEventArgs e)
    {
        model.ConfirmPassword = e?.Value?.ToString() ?? "";
        CheckPasswords();
        return Task.CompletedTask;
    }

    void CheckPasswords()
    {
        if (!string.IsNullOrWhiteSpace(model.Password)
            && model.Password == model.ConfirmPassword)
        {
            mes = "Les deux mots de passe correspondent";
            colorvar = "green";
            odiasble = false;
        }
        else
        {
            mes = "Les deux mots de passe ne correspondent pas";
            colorvar = "red";
            odiasble = true;
        }
        // Force UI update if needed (rare): StateHasChanged();
    }

    async Task Submit()
    {
        int it = model.Role == "enseignants" ? 1 : 0;
        int ist = model.Role == "etudiants" ? 1 : 0;

        int success = await Auth.SignupAsync(
            model.Username,
            model.Email,
            model.Password,
            it,
            ist,
            model.Nom,
            model.Prenoms,
            model.Role
        );
        if (success==1)
        {
            message = "Compte créé avec succès. Redirection...";
            await SecureStorage.SetAsync("username", model.Username);
            await SecureStorage.SetAsync("mustverify", "true"); 
            Nav.NavigateTo("/code");
        }
        else if (success==-1)
        {
            message = "Username ou email déja existant ";
        }
        else
        {
            message = "Erreur lors de la creation du compte veuillez reesayer";
        }
    }

    class SignupModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        public string Username { get; set; } = "";

        [Required]
        public string Nom { get; set; } = "";

        [Required]
        public string Prenoms { get; set; } = "";

        [Required, MinLength(6)]
        public string Password { get; set; } = "";

        [Required, Compare(nameof(Password))]
        public string ConfirmPassword { get; set; } = "";

        [Required]
        public string Role { get; set; } = "etudiants";
    }
}
