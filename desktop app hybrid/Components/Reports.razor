
@inject AuthService Auth
@inject NavigationManager Nav
@inject IJSRuntime JS
@using System.Data

<div class="app-shell">
    <div class="sidebar">
        <div class="logo-inline">
            <img class="logo-icon" src="https://i.ibb.co/yF9Ct6Vh/e45cad7b-df02-42d6-a6ee-1cbb9de115ab.jpg">
            <div class="logo-text">GradeMaster</div>
        </div>
        <Navbar />
        <div class="sidebar-footer">
            <a href="/login" class="nav-item">🚪 Déconnexion</a>
        </div>
    </div>

    <div class="main">
        <header class="topbar">
            <div class="topbar-title">Rapports et Logs</div>
            <div class="topbar-right">
                <span class="topbar-role">@userRole</span>
                <div class="topbar-user">
                    <span class="avatar"></span>
                    <a href="/login" class="link-button">Déconnexion</a>
                </div>
            </div>
        </header>

        <main class="content reports-page">
            <div class="content-inner">
                <div class="reports-header-row">
                    <h1>Journaux d'Activité</h1>
                    <div class="reports-actions">
                        <button class="secondary-button" type="button" @onclick="RefreshLogs">
                            🔄 Actualiser
                        </button>
                    </div>
                </div>

                <div class="filters-panel">
                    <div class="filter-top">
                        <div class="search-bar">
                            <span class="search-icon">🔍</span>
                            <input type="text" placeholder="Chercher dans les logs..." @bind="searchQuery" @bind:event="oninput" />
                        </div>
                    </div>

                    <div class="filters-grid">
                        <div class="filter-field">
                            <label>Période</label>
                            <select value="@selectedPeriod" @onchange="HandlePeriodChange">
                                <option value="all">Toutes les périodes</option>
                                <option value="today">Aujourd'hui</option>
                                <option value="week">Cette semaine</option>
                                <option value="month">Ce mois</option>
                            </select>
                        </div>
                    </div>

                    <div class="filters-actions">
                        <button class="primary-button" type="button" @onclick="ApplyFilters">🔎 Appliquer les filtres</button>
                        <button class="secondary-button" type="button" @onclick="ResetFilters">↺ Réinitialiser</button>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-mini">
                        <span class="stat-label">Total logs</span>
                        <span class="stat-value">@allLogs.Count</span>
                    </div>
                    <div class="stat-mini">
                        <span class="stat-label">Logs filtrés</span>
                        <span class="stat-value">@filteredLogs.Count</span>
                    </div>
                </div>

                <div class="logs-panel">
                    <div class="panel-header">
                        <h2>Journal d'Activité (@filteredLogs.Count entrées)</h2>
                    </div>
                    <div class="logs-table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 180px;">Date <span class="sort-icon" @onclick="() => SortByDate()">⇅</span></th>
                                    <th>Activité / Message</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (GetPaginatedLogs().Any())
                                {
                                    @foreach (var log in GetPaginatedLogs())
                                    {
                                        <tr>
                                            <td class="timestamp">@log.DateLog.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                            <td class="details"><span class="detail-text">@log.Valeur</span></td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="2" class="text-center empty-message">
                                            <div class="empty-icon">📭</div>
                                            <p>Aucun log ne correspond à votre recherche.</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (filteredLogs.Any())
                    {
                        <div class="pagination-container">
                            <button class="pagination-btn" @onclick="PreviousPage" disabled="@(currentPage == 1)">◀ Précédent</button>
                            <div class="pagination-info">Page @currentPage sur @totalPages | @filteredLogs.Count log(s)</div>
                            <button class="pagination-btn" @onclick="NextPage" disabled="@(currentPage >= totalPages)">Suivant ▶</button>
                        </div>
                    }
                </div>

                <footer class="footer-main">© 2025 GradeMaster. Tous droits réservés.</footer>
            </div>
        </main>
    </div>
</div>

@code {
    private string userRole = "Admin";
    private string searchQuery = "";
    private string selectedPeriod = "all";
    private List<LogEntry> allLogs = new();
    private List<LogEntry> filteredLogs = new();
    private const int pageSize = 20;
    private int currentPage = 1;
    private int totalPages => filteredLogs.Any() ? (int)Math.Ceiling(filteredLogs.Count / (decimal)pageSize) : 1;
    private bool sortDescending = true;

    protected override async Task OnInitializedAsync()
    {
        userRole = await SecureStorage.GetAsync("userRole") ?? "Admin";
        if (userRole != "Admin")
        {
            Nav.NavigateTo("/profile", true);
            return;
        }
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        try
        {
            allLogs.Clear();
            var result = await Auth.Selector("valeur, date_log", "logs", "1=1 ORDER BY date_log DESC");
            if (result.Rows.Count > 0)
            {
                foreach (DataRow row in result.Rows)
                {
                    string valeur = row["valeur"]?.ToString() ?? "";
                    DateTime dateLog = row.IsNull("date_log") ? DateTime.Now : Convert.ToDateTime(row["date_log"]);
                    allLogs.Add(new LogEntry { Valeur = valeur, DateLog = dateLog });
                }
            }
            filteredLogs = new List<LogEntry>(allLogs);
            ApplyFilters();
            await JS.InvokeVoidAsync("console.log", $"✅ {allLogs.Count} logs chargés");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"❌ Erreur chargement logs: {ex.Message}");
        }
    }

    private void ApplyFilters()
    {
        filteredLogs = allLogs.ToList();
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            filteredLogs = filteredLogs.Where(l => l.Valeur.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        DateTime now = DateTime.Now;
        switch (selectedPeriod)
        {
            case "today": filteredLogs = filteredLogs.Where(l => l.DateLog.Date == now.Date).ToList(); break;
            case "week": filteredLogs = filteredLogs.Where(l => l.DateLog >= now.AddDays(-7)).ToList(); break;
            case "month": filteredLogs = filteredLogs.Where(l => l.DateLog >= now.AddMonths(-1)).ToList(); break;
        }
        filteredLogs = sortDescending ? filteredLogs.OrderByDescending(l => l.DateLog).ToList() : filteredLogs.OrderBy(l => l.DateLog).ToList();
        currentPage = 1;
        StateHasChanged();
    }

    private void ResetFilters()
    {
        searchQuery = "";
        selectedPeriod = "all";
        ApplyFilters();
    }

    private async Task RefreshLogs()
    {
        await LoadLogs();
        await JS.InvokeVoidAsync("alert", "✅ Logs actualisés");
    }

    private void HandlePeriodChange(ChangeEventArgs e)
    {
        selectedPeriod = e?.Value?.ToString() ?? "all";
        ApplyFilters();
    }

    private void SortByDate()
    {
        sortDescending = !sortDescending;
        ApplyFilters();
    }

    private List<LogEntry> GetPaginatedLogs()
    {
        return filteredLogs.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            StateHasChanged();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            StateHasChanged();
        }
    }

    class LogEntry
    {
        public string Valeur { get; set; } = "";
        public DateTime DateLog { get; set; } = DateTime.Now;
    }
}
